name: Deploy Develop to Europe-West1

on:
  push:
    branches: [ develop ]
  workflow_dispatch:  # Allow manual deployment

env:
  PROJECT_ID: api-ai-blog-writer
  SERVICE_NAME: api-ai-blog-writer-dev
  REGION: europe-west1
  ENV: dev

jobs:
  deploy-develop:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GOOGLE_CLOUD_SA_KEY }}
        project_id: api-ai-blog-writer

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: api-ai-blog-writer

    - name: Configure Docker to use gcloud as a credential helper
      run: |
        gcloud auth configure-docker

    - name: Verify dev secrets exist
      run: |
        echo "Checking for dev environment secrets..."
        gcloud secrets describe blog-writer-env-dev --project=$PROJECT_ID || {
          echo "âŒ Secret 'blog-writer-env-dev' not found. Available secrets:"
          gcloud secrets list --project=$PROJECT_ID --format="table(name)"
          exit 1
        }
        echo "âœ… Secret 'blog-writer-env-dev' found"

    - name: Build and Deploy to Cloud Run (Develop)
      run: |
        echo "ðŸš€ Deploying to develop environment..."
        echo "Environment: ${{ env.ENV }}"
        echo "Region: ${{ env.REGION }}"
        echo "Service: ${{ env.SERVICE_NAME }}"
        
        gcloud builds submit \
          --config cloudbuild.yaml \
          --substitutions _REGION=${{ env.REGION }},_ENV=${{ env.ENV }},_SERVICE_NAME=${{ env.SERVICE_NAME }} \
          --project=$PROJECT_ID

    - name: Get service URL
      id: get-url
      run: |
        SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
          --region=${{ env.REGION }} \
          --project=$PROJECT_ID \
          --format="value(status.url)")
        echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_OUTPUT
        echo "ðŸŽ‰ Develop service deployed at: $SERVICE_URL"

    - name: Test deployment
      run: |
        echo "ðŸ§ª Testing develop deployment..."
        curl -f ${{ steps.get-url.outputs.SERVICE_URL }}/health || {
          echo "âŒ Health check failed"
          exit 1
        }
        echo "âœ… Health check passed"

    - name: Deployment Summary
      run: |
        echo "## ðŸš€ Develop Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** Develop" >> $GITHUB_STEP_SUMMARY
        echo "**Service URL:** ${{ steps.get-url.outputs.SERVICE_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "**Region:** ${{ env.REGION }}" >> $GITHUB_STEP_SUMMARY
        echo "**Service Name:** ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
        echo "- [API Documentation](${{ steps.get-url.outputs.SERVICE_URL }}/docs)" >> $GITHUB_STEP_SUMMARY
        echo "- [Health Check](${{ steps.get-url.outputs.SERVICE_URL }}/health)" >> $GITHUB_STEP_SUMMARY
        echo "- [API Configuration](${{ steps.get-url.outputs.SERVICE_URL }}/api/v1/config)" >> $GITHUB_STEP_SUMMARY
